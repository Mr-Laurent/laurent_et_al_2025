setwd("G:/Mon Drive/UG_metacells/Figures paper Aout/")

library(ComplexHeatmap)
library(dplyr)
library(ggplot2)
library(seriation)
library(tidyverse)
library(viridis)


load("./Grouped_objects/genelist_16nov22_Macs.rd") # genelist 150 Modules found on Enriched Macs
load("./Grouped_objects/MacsTot_z_mymod_150_metadata_goodlog_v3.rd")
load("./Grouped_objects/MacsfromMNP_select2_dgCmc_counts.rd") # dgcmtxcounts (has the metacells/gene counts)
load("./Grouped_objects/ht_Enrich_Macs.rd") # to match data from Enriched MNP to the MNP from the current whole LP cohort
row_mod_ord<- as.vector(unlist(row_order(ht)))
load("./Grouped_objects/ht_Total_Macs.rd")


#---------------------------------------#

colnames(genelist)<-c("Mods","Gens")
hm_zmod<-as.matrix(metadf_z[,c(154:303)])
df_zmod2<-as.data.frame(metadf_z[,c(2:3,154:303)])
colnames(df_zmod2)<-sub("([a-zA-Z_]+)(\\d+)([a-zA-Z]+)", "Module \\2", colnames(df_zmod2))  
preloco_nc<-as.matrix(log(1+dgcmtxcounts)) 
allsum<-Matrix::colSums(preloco_nc) 
row_mod_ord<- as.vector(unlist(row_order(ht)))
data.cpm<-1e+06*sweep(as.matrix(dgcmtxcounts),2,colSums(as.matrix(dgcmtxcounts)),`/`) 
preloco<-as.matrix(log2(1+(data.cpm/10)))  # Divide by 10 the CPM for more readability

###----------------------------------------------------------### 
#### Function to transform list of genes to vector readable #### 
#### by the program, with exclusion of unknown genes        ####
###----------------------------------------------------------### 
gene_input2vect<-function(genelist,dgcmtx){
  gnshow<-unlist(strsplit(genelist,split=","))
  gnshow<-gsub(" ","",gnshow)
  notfound<-setdiff(gnshow,rownames(dgcmtx))
  print( paste0("[",paste0(notfound,collapse =","),"] not found") )
  return(setdiff(gnshow,notfound) )
}
###----------------------------------------------------------### 
findgene <- function(x,y){
  for(i in 1:length(x)){
    if(y%in%unlist(x[i])){return(i)}
  }
}        

# Genes to show in the truthplot:
gn_XIV<-c("CXCL8,SERPINB2,MFSD2A,F3,IL1A,TNF")
gn_XV<-c("IL7R,IDO1,INHBA,CD274,IL3RA,P2RX7,SLAMF1,CRIM1,SLC39A8,SLC7A11,ADAM19,SPP1")
gn_XVII<-c("DNAJB4,HSPA6,FCGR2B,CA2,SCD,BNIP3,RRAD,SLC2A1")
gn_IX<-c("IFI44L,CXCL10,CXCL9,IFIT2,OAS2,CXCL11")
gn_XIII<-c("IL23A,CD40,SLAMF7,CCL20,CXCL3,CXCL2")
gn_VIII<-c("S100A8,S100A9,VCAN,FCN1,RIPOR2,S100A12,APOBEC3A")
gn_VII<-c("SELL,FCAR,ALOX5AP,RETN,MCEMP1,OSM")
gn_XII<-c("IL10,CDK1,RAB7B,TPRA1,LY6K,BCL11A,PHLDB1,MMP19,EREG")
#gn_I<-c("CTSD,MS4A4A,MS4A6A,HRH2,ITGA4,CD36,ATOX1,CPVL,BST2")
gn_II<-c("ATP5PB,MRPS21,RNF7,NDUFB5,ATP5ME")
#gn_IV<-c("MNDA,VAMP5,LY96,C3AR1,CALM2")
gn_VI<-c("CSF1R,CD72,CD101,IL18")
gn_V<-c("C1QA,VSIG4,DNASE1L3,DAB2,PDK4,SLCO2B1,CMKLR1,CD209,FUCA1,MERTK,SELENOP,FOLR2,IGF1,AXL,LYVE1")

gnlist<-paste(gn_XIV,gn_XV,gn_XVII,gn_IX,gn_XIII,gn_VIII,gn_VII,gn_XII,gn_II,gn_VI,gn_V,sep=",")


# Annotation to cluster
grp_cell<-c("Mono1",
            "Mono3","Mono4","Mono5",
            "Macro6","Macro7","Macro8","Macro9")
grp_cls<-c("38,37,31,26,32,34,35,39,40", 
           "36,22", "20,21,3","4,11,5,7,6,29,28",
           "1,33,25", "30,23,27,24", "15,2,14,9,10,8", "12,16,13,19,17,18")


# Mono 1 reorder
ann_clu="38,37,31,26,32,34,35,39,40"
ann_clu_show<-unlist(strsplit(ann_clu,split=","))
ann_clu_show<-gsub(" ","",ann_clu_show)
mc_part1<-rownames(hm_zmod)[as.vector(unlist( column_order(ht)[as.numeric(ann_clu_show)]   )) ]
set.seed(42)
mc_part1_rdm<-sample(mc_part1)

ann_clu2="36,22,20,21,3,4,11,5,7,6,29,28,1,33,25,30,23,27,24,15,2,14,9,10,8,12,16,13,19,17,18"
ann_clu_show2<-unlist(strsplit(ann_clu2,split=","))
ann_clu_show2<-gsub(" ","",ann_clu_show2)
mc_part2<-rownames(hm_zmod)[as.vector(unlist(  column_order(ht)[as.numeric(ann_clu_show2)] )) ]
mc_ordhm<-append(mc_part1_rdm,mc_part2)


htmxord<-t(hm_zmod)[as.vector(unlist(row_order(ht))),mc_ordhm]
gnshow<-unlist(strsplit(gnlist,split=","))                                                                          
gnshow<-gsub(" ","",gnshow)                                                                                                 
notfound<-setdiff(gnshow,rownames(dgcmtxcounts)) 

#Subset on shon genes
loco<-preloco[setdiff(gnshow,notfound),colnames(htmxord)]


lim_ord=colnames(htmxord)
# Change format to a ggplot2-compatible dataframe
hmgg2<-loco%>% 
  as.data.frame() %>%
  rownames_to_column("genes") %>%
  pivot_longer(-c(genes), names_to = "metacells", values_to = "counts")

# plot with raster as the heatmap is large
reordplot<-ggplot(hmgg2,aes(x=metacells, y=genes, fill=counts)) + 
  geom_raster() + scale_x_discrete(limits=lim_ord)+ 
  scale_y_discrete(limits=rev(rownames(loco)))+
  scale_fill_gradientn(colors = viridis(n = 256, alpha = 1, begin = 0,end = 1, option = "viridis"))+
  theme(axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y = element_text(size = rel(0.7)) )

pdf(file="./Figure 2S/FigS2B_Truthplot_totalLP_MoMacs.pdf",width = 8,height = 7.5)
print(reordplot)
dev.off()
